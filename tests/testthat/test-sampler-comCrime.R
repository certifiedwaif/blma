context('blma comCrime')
library(parallel)
cores <- detectCores()
#cores <- 1
get_comCrime  <- function()
{
    # Fill in
    data(comData)
    Y <- comData[, 1:18]
    X <- comData[, 19:142]
    # Data preparation

    sum.na <- function(x) {  sum(is.na(x)); }
    inds <- which(apply(X,2,sum.na)==0)
    X2 <- X[,inds]
    X3 <- X2[,!colnames(X2)%in%c("ownHousQrange","rentQrange")]

    y <- Y[, 18]
    inds <- which(is.na(y))

    vy <- y[-inds]
    mX <- X3[-inds,] %>% as.matrix
    mX.til <- cbind(1,mX)

    n <- length(vy)
    p <- ncol(mX)

    mult <- sqrt(n/(n-1))
    mX <- mX
    for (j in 1:p) {
      mX[,j] = mult*(mX[,j] - mean(mX[,j]))/sd(mX[,j])
    }
    vy <- mult*(vy - mean(vy))/sd(vy)
    return(list(vy=vy, mX=mX))
}
normalize <- function(y, X)
{
  n <- length(y)
  p <- ncol(X)

  mu.y <- mean(y)
  sigma2.y <- (n - 1) * var(y) / n
  vy <- (y - mu.y) / sqrt(sigma2.y)

  # Normalise covariates
  mX <- matrix(0, n, p)
  mu.x <- c()
  sigma2.x <- c()
  for (j in 1:p)
  {
    mu.x[j] <- mean(X[, j])
    sigma2.x[j] <- (n - 1) * var(X[, j]) / n
    mX[, j] <- (X[, j] - mu.x[j]) / sqrt(sigma2.x[j])
  }

  return(list(vy = vy, mX = mX, mu.y = mu.y, sigma2.y = sigma2.y, mu.x = mu.x, sigma2.x = sigma2.x))
}
test_that('comCrime produces correct results BIC', {
			  skip("I don't care about this right now")
	set.seed(2019)
    comCrime <- get_comCrime()
    vy <- comCrime$vy
    mX <- comCrime$mX
    result <- sampler(100000, vy, mX, prior='BIC', modelprior='uniform', cores=cores)
    expect_equal(result$vinclusion_prob, 
c(
0.94740000000000002,0.26622000000000001,0.08648000000000000,
0.43586999999999998,0.09908000000000000,0.45071000000000000,
0.04505000000000000,0.07826000000000000,0.04751000000000000,
0.20030000000000001,0.09268000000000000,0.03688000000000000,
0.11712000000000000,0.14110000000000000,0.02372000000000000,
0.03100000000000000,0.08356000000000000,0.04962000000000000,
0.04672000000000000,0.05529000000000000,0.06586000000000000,
0.07400000000000000,0.06235000000000000,0.04791000000000000,
0.03643000000000000,0.02986000000000000,0.07804999999999999,
0.04897000000000000,0.07392000000000000,0.03489000000000000,
0.07693000000000000,0.03548000000000000,0.04866000000000000,
0.02920000000000000,0.04345000000000000,0.02995000000000000,
0.03347000000000000,0.04446000000000000,0.03263000000000000,
0.80427000000000004,0.18221000000000001,0.05037000000000000,
0.21812000000000001,0.77812999999999999,0.04353000000000000,
0.12110000000000000,0.02568000000000000,0.02440000000000000,
0.92418000000000000,0.98036000000000001,0.97057000000000004,
0.04015000000000000,0.05150000000000000,0.15984000000000001,
0.68164999999999998,0.03199000000000000,0.03791000000000000,
0.03491000000000000,0.03524000000000000,0.37684000000000001,
0.05378000000000000,0.08116000000000000,0.05427000000000000,
0.06267000000000000,0.04224000000000000,0.09243000000000000,
0.07270000000000000,0.05966000000000000,0.03249000000000000,
0.02321000000000000,0.90103999999999995,0.06898000000000000,
0.04904000000000000,0.02438000000000000,0.09001000000000001,
0.03362000000000000,0.02942000000000000,0.13260000000000000,
0.37035000000000001,0.23374000000000000,0.24353000000000000,
0.02644000000000000,0.02986000000000000,0.03506000000000000,
0.03605000000000000,0.02414000000000000,0.24012000000000000,
0.02817000000000000,0.21396999999999999,0.38860000000000000,
0.04076000000000000,0.02999000000000000,0.33513999999999999,
0.04466000000000000,0.03532000000000000,0.02461000000000000,
0.02493000000000000,0.02511000000000000,0.70140000000000002
  )
, tolerance = 1e-5)
})
test_that('comCrime produces correct results ZE', {
	skip("I don't care about this right now")
	set.seed(2019)
    comCrime <- get_comCrime()
    vy <- comCrime$vy
    mX <- comCrime$mX
    result <- sampler(100000, vy, mX, prior='ZE', modelprior='uniform', cores=cores)
    expect_equal(result$vinclusion_prob, 
				 c(
0.94652000000000003,0.76881999999999995,0.21004000000000000,
0.80601999999999996,0.18861000000000000,0.61153999999999997,
0.15892999999999999,0.31552999999999998,0.18381000000000000,
0.46372000000000002,0.28755999999999998,0.24101000000000000,
0.16950999999999999,0.22846000000000000,0.09386000000000000,
0.11037000000000000,0.19811000000000001,0.16356999999999999,
0.23360000000000000,0.13303999999999999,0.21229999999999999,
0.19106000000000001,0.23682000000000000,0.17039000000000001,
0.15121999999999999,0.11920000000000000,0.19186000000000000,
0.13411000000000001,0.31228000000000000,0.14785000000000001,
0.38558999999999999,0.12872000000000000,0.13353000000000001,
0.13897999999999999,0.20521000000000000,0.13178000000000001,
0.14008999999999999,0.14468000000000000,0.13225000000000001,
0.79439000000000004,0.26307999999999998,0.17544999999999999,
0.33228000000000002,0.63861000000000001,0.18845999999999999,
0.36093999999999998,0.11133000000000000,0.11153000000000000,
0.88029000000000002,0.96462999999999999,0.96448999999999996,
0.11654000000000000,0.16206999999999999,0.22911000000000001,
0.61292000000000002,0.12328000000000000,0.17072999999999999,
0.14380999999999999,0.14602000000000001,0.32174999999999998,
0.13525999999999999,0.31498999999999999,0.23190000000000000,
0.23524999999999999,0.23554000000000000,0.32361000000000001,
0.20899999999999999,0.54813000000000001,0.14784000000000000,
0.09420000000000001,0.93078000000000005,0.20771999999999999,
0.19017000000000001,0.10370000000000000,0.19575999999999999,
0.11193000000000000,0.14513000000000001,0.28532000000000002,
0.33246999999999999,0.24446999999999999,0.27033000000000001,
0.11441999999999999,0.13206000000000001,0.29209000000000002,
0.18156000000000000,0.10234000000000000,0.65824000000000005,
0.13550000000000001,0.32285999999999998,0.56325000000000003,
0.11633000000000000,0.12889000000000000,0.78490000000000004,
0.15919000000000000,0.14621000000000001,0.10469000000000001,
0.09723999999999999,0.09600000000000000,0.91712000000000005
)
, tolerance = 1e-5)
})
test_that('comCrime produces correct results liang_g1', {
	skip("I don't care about this right now")
	set.seed(2019)
    comCrime <- get_comCrime()
    vy <- comCrime$vy
    mX <- comCrime$mX
    result <- sampler(100000, vy, mX, prior='liang_g1', modelprior='uniform', cores=cores)
    expect_equal(result$vinclusion_prob, 
		c(
0.9544200000000000,0.8700100000000000,0.3064800000000000,0.8621200000000000,
0.2789700000000000,0.6560600000000000,0.2510500000000000,0.4098600000000000,
0.2769200000000000,0.5556300000000000,0.4853300000000000,0.4531300000000000,
0.2581100000000000,0.2950200000000000,0.1721500000000000,0.1862400000000000,
0.2547200000000000,0.2384200000000000,0.3761000000000000,0.2205700000000000,
0.3786900000000000,0.3114700000000000,0.3950200000000000,0.2736600000000000,
0.2561700000000000,0.2076500000000000,0.2844200000000000,0.2215000000000000,
0.5234100000000000,0.2842700000000000,0.6075600000000000,0.2140700000000000,
0.2110600000000000,0.2602500000000000,0.3965100000000000,0.2248100000000000,
0.2425500000000000,0.2391600000000000,0.2235600000000000,0.8088000000000000,
0.3391400000000000,0.2436800000000000,0.3997600000000000,0.6137500000000000,
0.3200200000000000,0.5093200000000000,0.1987800000000000,0.2034700000000000,
0.8568300000000000,0.9657300000000000,0.9638600000000001,0.1940300000000000,
0.2670000000000000,0.3017900000000000,0.6335300000000000,0.2234100000000000,
0.3057200000000000,0.2673900000000000,0.2448100000000000,0.3417800000000000,
0.2296900000000000,0.4130500000000000,0.3107200000000000,0.3819300000000000,
0.4578400000000000,0.3973000000000000,0.4305400000000000,0.7434400000000000,
0.2540300000000000,0.1746400000000000,0.9404000000000000,0.2939500000000000,
0.4155700000000000,0.2014400000000000,0.2795300000000000,0.1957200000000000,
0.2625600000000000,0.4036600000000000,0.4234100000000000,0.3201700000000000,
0.3497100000000000,0.2157700000000000,0.2425300000000000,0.5873000000000000,
0.3849400000000000,0.1792100000000000,0.7591000000000000,0.2247600000000000,
0.3996000000000000,0.6204000000000000,0.1952700000000000,0.2182600000000000,
0.8663300000000000,0.2514200000000000,0.2246700000000000,0.1866900000000000,
0.1768500000000000,0.1768700000000000,0.9513600000000000
		)
, tolerance = 1e-5)
})
test_that('comCrime produces correct results liang_g2', {
	skip("I don't care about this right now")
	set.seed(2019)
    comCrime <- get_comCrime()
    vy <- comCrime$vy
    mX <- comCrime$mX
    result <- sampler(100000, vy, mX, prior='liang_g2', modelprior='uniform', cores=cores)
    expect_equal(result$vinclusion_prob, c(
		0.9544200000000000,0.8700100000000000,0.3064800000000000,0.8621200000000000,
		0.2789700000000000,0.6560600000000000,0.2510500000000000,0.4098600000000000,
		0.2769200000000000,0.5556300000000000,0.4853300000000000,0.4531300000000000,
		0.2581100000000000,0.2950200000000000,0.1721500000000000,0.1862400000000000,
		0.2547200000000000,0.2384200000000000,0.3761000000000000,0.2205700000000000,
		0.3786900000000000,0.3114700000000000,0.3950200000000000,0.2736600000000000,
		0.2561700000000000,0.2076500000000000,0.2844200000000000,0.2215000000000000,
		0.5234100000000000,0.2842700000000000,0.6075600000000000,0.2140700000000000,
		0.2110600000000000,0.2602500000000000,0.3965100000000000,0.2248100000000000,
		0.2425500000000000,0.2391600000000000,0.2235600000000000,0.8088000000000000,
		0.3391400000000000,0.2436800000000000,0.3997600000000000,0.6137500000000000,
		0.3200200000000000,0.5093200000000000,0.1987800000000000,0.2034700000000000,
		0.8568300000000000,0.9657300000000000,0.9638600000000001,0.1940300000000000,
		0.2670000000000000,0.3017900000000000,0.6335300000000000,0.2234100000000000,
		0.3057200000000000,0.2673900000000000,0.2448100000000000,0.3417800000000000,
		0.2296900000000000,0.4130500000000000,0.3107200000000000,0.3819300000000000,
		0.4578400000000000,0.3973000000000000,0.4305400000000000,0.7434400000000000,
		0.2540300000000000,0.1746400000000000,0.9404000000000000,0.2939500000000000,
		0.4155700000000000,0.2014400000000000,0.2795300000000000,0.1957200000000000,
		0.2625600000000000,0.4036600000000000,0.4234100000000000,0.3201700000000000,
		0.3497100000000000,0.2157700000000000,0.2425300000000000,0.5873000000000000,
		0.3849400000000000,0.1792100000000000,0.7591000000000000,0.2247600000000000,
		0.3996000000000000,0.6204000000000000,0.1952700000000000,0.2182600000000000,
		0.8663300000000000,0.2514200000000000,0.2246700000000000,0.1866900000000000,
		0.1768500000000000,0.1768700000000000,0.9513600000000000
	)
, tolerance = 1e-5)
})
test_that('comCrime produces correct results liang_g_n_approx', {
	skip("I don't care about this right now")
	set.seed(2019)
    comCrime <- get_comCrime()
    vy <- comCrime$vy
    mX <- comCrime$mX
    result <- sampler(100000, vy, mX, prior='liang_g_n_approx', modelprior='uniform', cores=cores)
    expect_equal(result$vinclusion_prob, 
c(
0.9538600000000000,0.8663999999999999,0.3010200000000000,0.8603200000000000,
0.2739900000000000,0.6520100000000000,0.2452700000000000,0.4059500000000000,
0.2718500000000000,0.5524900000000000,0.4741700000000000,0.4384200000000000,
0.2528300000000000,0.2880500000000000,0.1672800000000000,0.1802800000000000,
0.2535500000000000,0.2361300000000000,0.3673300000000000,0.2155200000000000,
0.3723700000000000,0.3060600000000000,0.3894600000000000,0.2676500000000000,
0.2503500000000000,0.2026900000000000,0.2797400000000000,0.2173300000000000,
0.5142900000000000,0.2770800000000000,0.5967800000000000,0.2101600000000000,
0.2054600000000000,0.2550200000000000,0.3879900000000000,0.2186000000000000,
0.2347400000000000,0.2367000000000000,0.2211600000000000,0.8075200000000000,
0.3348100000000000,0.2375300000000000,0.3937300000000000,0.6151000000000000,
0.3144100000000000,0.5036600000000000,0.1942100000000000,0.1982100000000000,
0.8570100000000000,0.9662600000000000,0.9642300000000000,0.1901300000000000,
0.2622900000000000,0.2975600000000000,0.6327100000000000,0.2167800000000000,
0.2998600000000000,0.2616300000000000,0.2390900000000000,0.3415800000000000,
0.2243800000000000,0.4054900000000000,0.3111500000000000,0.3709900000000000,
0.4499700000000000,0.3931500000000000,0.4244300000000000,0.7387100000000000,
0.2458700000000000,0.1697500000000000,0.9404400000000001,0.2874800000000000,
0.4062400000000000,0.1944800000000000,0.2763900000000000,0.1908900000000000,
0.2575600000000000,0.3969000000000000,0.4173400000000000,0.3142900000000000,
0.3471600000000000,0.2080200000000000,0.2342000000000000,0.5782800000000000,
0.3775600000000000,0.1750900000000000,0.7576300000000000,0.2211700000000000,
0.3931900000000000,0.6207300000000000,0.1911100000000000,0.2135000000000000,
0.8650099999999999,0.2473800000000000,0.2201700000000000,0.1823300000000000,
0.1718900000000000,0.1719200000000000,0.9506900000000000
)
, tolerance = 1e-5)
})
test_that('comCrime produces correct results liang_g_n_quad', {
	set.seed(2019)
    comCrime <- get_comCrime()
    vy <- comCrime$vy
    mX <- comCrime$mX
    result <- sampler(100000, vy, mX, prior='liang_g_n_quad', modelprior='uniform', cores=cores)
    expect_equal(result$vinclusion_prob, 
c(
0.9547500000000000,0.8645200000000000,0.2978900000000000,0.8612300000000001,
0.2703900000000000,0.6538100000000000,0.2420400000000000,0.4038500000000000,
0.2664800000000000,0.5470400000000000,0.4669400000000000,0.4362700000000000,
0.2494800000000000,0.2860500000000000,0.1656900000000000,0.1783700000000000,
0.2526200000000000,0.2333100000000000,0.3664700000000000,0.2129700000000000,
0.3644300000000000,0.3046700000000000,0.3824700000000000,0.2644800000000000,
0.2468800000000000,0.1990200000000000,0.2754100000000000,0.2146500000000000,
0.5100000000000000,0.2702800000000000,0.5911200000000000,0.2067600000000000,
0.2046500000000000,0.2507900000000000,0.3814400000000000,0.2163000000000000,
0.2318200000000000,0.2339300000000000,0.2166400000000000,0.8040000000000000,
0.3374100000000000,0.2373900000000000,0.3902400000000000,0.6205900000000000,
0.3077600000000000,0.5002600000000000,0.1910600000000000,0.1965700000000000,
0.8591100000000000,0.9672400000000000,0.9636900000000000,0.1886000000000000,
0.2591600000000000,0.2985600000000000,0.6283800000000000,0.2130700000000000,
0.2942200000000000,0.2571800000000000,0.2348800000000000,0.3375400000000000,
0.2208100000000000,0.4040000000000000,0.3101700000000000,0.3710000000000000,
0.4411800000000000,0.3922900000000000,0.4137700000000000,0.7348600000000000,
0.2431500000000000,0.1677400000000000,0.9396099999999999,0.2877300000000000,
0.3959600000000000,0.1909800000000000,0.2730300000000000,0.1890800000000000,
0.2532200000000000,0.3960300000000000,0.4130300000000000,0.3155900000000000,
0.3434800000000000,0.2052500000000000,0.2311600000000000,0.5709600000000000,
0.3740500000000000,0.1726400000000000,0.7559200000000000,0.2187300000000000,
0.3920100000000000,0.6177200000000000,0.1883800000000000,0.2105400000000000,
0.8637899999999999,0.2442100000000000,0.2182500000000000,0.1793900000000000,
0.1693700000000000,0.1690400000000000,0.9499600000000000
)
, tolerance = 1e-5)
})
test_that('comCrime produces correct results robust_bayarri1', {
			  skip('Not working yet')
    comCrime <- get_comCrime()
    vy <- comCrime$vy
    mX <- comCrime$mX
    result <- sampler(10000, vy, mX, prior='robust_bayarri1', modelprior='uniform', cores=cores)
    expect_equal(result$vinclusion_prob, c(0.9232757119159278,
0.05741274306903849,
0.03742284736827773,
0.1815137280723433,
0.04405392031090839,
0.3515,
0.0123,
0.0155,
0.0121,
0.0562,
0.0862,
0.0106,
0.075,
0.0494,
0.0074,
0.0095,
0.0264,
0.0167,
0.0091,
0.0286,
0.0185,
0.022,
0.0206,
0.0159,
0.0091,
0.0091,
0.0596,
0.018,
0.0289,
0.0131,
0.0152,
0.0114,
0.0176,
0.0055,
0.0154,
0.008999999999999999,
0.0074,
0.0162,
0.0092,
0.8622,
0.1342,
0.0138,
0.1654,
0.8372000000000001,
0.0109,
0.0367,
0.008999999999999999,
0.0078,
0.8939,
0.9931,
0.9141,
0.0216,
0.0268,
0.1315,
0.7723,
0.0129,
0.0156,
0.0146,
0.0169,
0.4625,
0.0532,
0.0192,
0.0154,
0.0192,
0.0122,
0.0149,
0.0296,
0.0129,
0.009599999999999999,
0.0061,
0.7195,
0.0272,
0.0173,
0.007900000000000001,
0.0407,
0.0094,
0.009299999999999999,
0.0588,
0.4325,
0.2244,
0.2143,
0.008500000000000001,
0.0143,
0.0104,
0.0218,
0.0073,
0.07870000000000001,
0.007900000000000001,
0.1031,
0.2191,
0.0297,
0.0071,
0.0927,
0.01,
0.0097,
0.0067,
0.0092,
0.008,
0.4742)
, tolerance = 1e-8)
})
test_that('comCrime produces correct results robust_bayarri2', {
			  skip('Not working yet')
    comCrime <- get_comCrime()
    vy <- comCrime$vy
    mX <- comCrime$mX
    result <- sampler(10000, vy, mX, prior='robust_bayarri2', modelprior='uniform', cores=cores)
    expect_equal(result$vinclusion_prob, c(0.9350757119159278,
0.05851274306903849,
0.03092284736827773,
0.1622137280723433,
0.03895392031090839,
0.343,
0.0102,
0.0179,
0.0112,
0.0563,
0.0711,
0.0095,
0.0844,
0.0442,
0.0089,
0.0069,
0.0217,
0.0166,
0.0086,
0.0354,
0.0191,
0.0236,
0.0213,
0.0158,
0.0105,
0.008399999999999999,
0.0518,
0.0177,
0.026,
0.0107,
0.013,
0.008699999999999999,
0.0185,
0.008399999999999999,
0.0173,
0.0073,
0.0105,
0.0168,
0.008200000000000001,
0.8310999999999999,
0.1669,
0.009599999999999999,
0.1326,
0.8686,
0.0128,
0.0342,
0.008399999999999999,
0.0077,
0.9097,
0.9905,
0.9312,
0.0195,
0.0209,
0.1454,
0.7622,
0.0134,
0.0112,
0.018,
0.0159,
0.4837,
0.0429,
0.0222,
0.0146,
0.0145,
0.0129,
0.021,
0.0281,
0.0151,
0.0102,
0.0064,
0.7423,
0.0309,
0.0168,
0.008,
0.0412,
0.0103,
0.008699999999999999,
0.0621,
0.4339,
0.2032,
0.2289,
0.0094,
0.0143,
0.0118,
0.0188,
0.0069,
0.07149999999999999,
0.008,
0.107,
0.2147,
0.0328,
0.0055,
0.0891,
0.0115,
0.0081,
0.0083,
0.0069,
0.0091,
0.4577)
, tolerance = 1e-8)
})
test_that('comCrime produces correct results zellner_siow_gauss_laguerre', {
			  skip('Not working yet')
    comCrime <- get_comCrime()
    vy <- comCrime$vy
    mX <- comCrime$mX
    result <- sampler(10000, vy, mX, prior='zellner_siow_gauss_laguerre', modelprior='uniform', cores=cores)
    expect_equal(result$vinclusion_prob, c(0.8629757119159278,
0.02891274306903849,
0.02222284736827773,
0.1175137280723433,
0.02695392031090839,
0.3031,
0.0073,
0.0138,
0.008699999999999999,
0.0374,
0.1358,
0.0045,
0.0868,
0.0296,
0.0034,
0.0047,
0.0149,
0.0136,
0.007,
0.0344,
0.01,
0.0129,
0.0139,
0.0094,
0.0077,
0.0064,
0.0526,
0.0135,
0.0232,
0.0064,
0.007,
0.0056,
0.0102,
0.0046,
0.0104,
0.0055,
0.0048,
0.0091,
0.0047,
0.8866000000000001,
0.1147,
0.0072,
0.1092,
0.8783,
0.0065,
0.0212,
0.0038,
0.0043,
0.8704,
0.982,
0.8803,
0.0145,
0.0179,
0.1543,
0.7707000000000001,
0.0094,
0.0071,
0.0143,
0.0098,
0.5109,
0.0369,
0.0155,
0.0089,
0.0101,
0.008399999999999999,
0.0139,
0.0147,
0.01,
0.006,
0.0043,
0.6128,
0.0241,
0.0098,
0.0043,
0.0312,
0.0048,
0.0056,
0.0416,
0.3912,
0.2466,
0.2158,
0.0051,
0.0141,
0.008200000000000001,
0.0195,
0.0044,
0.046,
0.0062,
0.0722,
0.1793,
0.0298,
0.0047,
0.0509,
0.006,
0.0051,
0.0055,
0.0048,
0.0052,
0.4031)
, tolerance = 1e-8)
})
